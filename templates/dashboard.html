<!DOCTYPE html>
<html lang="en" data-theme="terminal" data-mode="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#060a0e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ollama">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
<title>OLLAMA // CONTROL CENTER</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Orbitron:wght@400;600;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SYSTEM â€” 3 themes x 2 modes = 6 visual modes
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="terminal"][data-mode="dark"] {
  --bg-deep:#060a0e; --bg-panel:#0c1117; --bg-panel-alt:#0f161d;
  --border:#1a2736; --border-glow:#1e3a50;
  --text-primary:#c8d4de; --text-dim:#5a6a7a; --text-muted:#3a4a5a;
  --accent-1:#00e87b; --accent-2:#f0a030; --accent-3:#00c8e0; --accent-4:#3080ff; --accent-err:#ff3b4a;
  --glow-1:rgba(0,232,123,0.15); --glow-2:rgba(240,160,48,0.15);
  --font-display:'Share Tech Mono', monospace; --font-body:'JetBrains Mono', monospace;
  --radius:6px; --scanline:rgba(0,0,0,0.03); --bg-gradient:none;
  --card-hover-shadow:none; --card-hover-transform:none;
}
[data-theme="terminal"][data-mode="light"] {
  --bg-deep:#f0f2f4; --bg-panel:#ffffff; --bg-panel-alt:#f6f8fa;
  --border:#d8dce0; --border-glow:#b0b8c0;
  --text-primary:#1a2430; --text-dim:#5a6878; --text-muted:#8a96a4;
  --accent-1:#00a858; --accent-2:#c08020; --accent-3:#0090a8; --accent-4:#2060d0; --accent-err:#d0283a;
  --glow-1:rgba(0,168,88,0.08); --glow-2:rgba(192,128,32,0.08);
  --font-display:'Share Tech Mono', monospace; --font-body:'JetBrains Mono', monospace;
  --radius:6px; --scanline:transparent; --bg-gradient:none;
  --card-hover-shadow:0 2px 8px rgba(0,0,0,0.06); --card-hover-transform:none;
}
[data-theme="cyberpunk"][data-mode="dark"] {
  --bg-deep:#0d0221; --bg-panel:#150535; --bg-panel-alt:#1a0a40;
  --border:#2a1060; --border-glow:#6b20d0;
  --text-primary:#e0d0ff; --text-dim:#8a6abf; --text-muted:#5a3a8f;
  --accent-1:#00ff8a; --accent-2:#ff2d7a; --accent-3:#00e5ff; --accent-4:#ffe03a; --accent-err:#ff2d4a;
  --glow-1:rgba(0,255,138,0.2); --glow-2:rgba(255,45,122,0.2);
  --font-display:'Orbitron', sans-serif; --font-body:'JetBrains Mono', monospace;
  --radius:8px; --scanline:rgba(255,45,122,0.015);
  --bg-gradient:radial-gradient(ellipse at 20% 50%,rgba(107,32,208,0.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(255,45,122,0.08) 0%,transparent 50%);
  --card-hover-shadow:0 4px 20px rgba(107,32,208,0.2); --card-hover-transform:translateY(-2px);
}
[data-theme="cyberpunk"][data-mode="light"] {
  --bg-deep:#f4f0ff; --bg-panel:#ffffff; --bg-panel-alt:#f8f4ff;
  --border:#d8c8f0; --border-glow:#a070e0;
  --text-primary:#1a0840; --text-dim:#6a4a9f; --text-muted:#a088c8;
  --accent-1:#00b860; --accent-2:#d0206a; --accent-3:#0098c0; --accent-4:#c0a000; --accent-err:#d01840;
  --glow-1:rgba(0,184,96,0.1); --glow-2:rgba(208,32,106,0.1);
  --font-display:'Orbitron', sans-serif; --font-body:'JetBrains Mono', monospace;
  --radius:8px; --scanline:transparent; --bg-gradient:none;
  --card-hover-shadow:0 4px 16px rgba(107,32,208,0.08); --card-hover-transform:translateY(-1px);
}
[data-theme="ocean"][data-mode="dark"] {
  --bg-deep:#04101e; --bg-panel:#081828; --bg-panel-alt:#0a1e32;
  --border:#14304a; --border-glow:#1e5080;
  --text-primary:#c4daf0; --text-dim:#6890b0; --text-muted:#3a5a78;
  --accent-1:#00d4aa; --accent-2:#2898ff; --accent-3:#50c8ff; --accent-4:#ff8a40; --accent-err:#ff4050;
  --glow-1:rgba(0,212,170,0.15); --glow-2:rgba(40,152,255,0.18);
  --font-display:'Exo 2', sans-serif; --font-body:'JetBrains Mono', monospace;
  --radius:10px; --scanline:transparent;
  --bg-gradient:radial-gradient(ellipse at 30% 80%,rgba(40,152,255,0.06) 0%,transparent 60%),radial-gradient(ellipse at 70% 20%,rgba(0,212,170,0.04) 0%,transparent 50%);
  --card-hover-shadow:0 2px 16px rgba(40,152,255,0.1); --card-hover-transform:none;
}
[data-theme="ocean"][data-mode="light"] {
  --bg-deep:#f0f6fc; --bg-panel:#ffffff; --bg-panel-alt:#f4f9ff;
  --border:#c8d8e8; --border-glow:#7098c0;
  --text-primary:#0a1e30; --text-dim:#4a6a88; --text-muted:#90a8c0;
  --accent-1:#00a888; --accent-2:#1878d0; --accent-3:#3098d0; --accent-4:#d07030; --accent-err:#d03040;
  --glow-1:rgba(0,168,136,0.08); --glow-2:rgba(24,120,208,0.08);
  --font-display:'Exo 2', sans-serif; --font-body:'JetBrains Mono', monospace;
  --radius:10px; --scanline:transparent; --bg-gradient:none;
  --card-hover-shadow:0 2px 12px rgba(40,120,208,0.06); --card-hover-transform:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  background-image: var(--bg-gradient);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
}
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
  background: repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scanline) 2px,var(--scanline) 4px);
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 20px; border-bottom:1px solid var(--border);
  background: var(--bg-panel-alt); flex-wrap:wrap; gap:10px;
}
.header-left { display:flex; align-items:center; gap:14px; }
.logo-mark {
  width:34px; height:34px; border:2px solid var(--accent-1);
  border-radius:var(--radius); display:flex; align-items:center; justify-content:center;
  font-size:18px; font-weight:700; color:var(--accent-1);
  text-shadow:0 0 12px var(--glow-1);
  animation:logoPulse 3s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100%{box-shadow:0 0 8px var(--glow-1)}
  50%{box-shadow:0 0 20px var(--glow-1)}
}
.header-title {
  font-family:var(--font-display); font-size:20px; letter-spacing:3px; color:var(--text-primary);
}
.header-title span { color:var(--text-muted); }
.header-right { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

/* â”€â”€ Nav tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav-tabs { display:flex; gap:4px; }
.nav-tab {
  background:transparent; border:1px solid var(--border); color:var(--text-dim);
  font-family:var(--font-body); font-size:13px; letter-spacing:1px;
  text-transform:uppercase; padding:5px 12px; border-radius:var(--radius);
  cursor:pointer; transition:all 0.2s;
}
.nav-tab:hover { border-color:var(--accent-1); color:var(--accent-1); }
.nav-tab.active { border-color:var(--accent-1); color:var(--accent-1); background:var(--glow-1); }

/* â”€â”€ Theme controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.theme-controls { display:flex; align-items:center; gap:8px; }
.theme-select {
  background:var(--bg-deep); border:1px solid var(--border);
  color:var(--text-primary); font-family:var(--font-body); font-size:13px;
  padding:5px 8px; border-radius:var(--radius); cursor:pointer;
}
.mode-toggle {
  width:40px; height:22px; border-radius:11px; cursor:pointer;
  background:var(--border); position:relative; border:none; transition:background 0.3s;
}
.mode-toggle::after {
  content:''; position:absolute; top:3px; left:3px;
  width:16px; height:16px; border-radius:50%;
  background:var(--text-primary); transition:transform 0.3s;
}
[data-mode="light"] .mode-toggle { background:var(--accent-1); }
[data-mode="light"] .mode-toggle::after { transform:translateX(18px); }
.mode-label { font-size:13px; color:var(--text-dim); letter-spacing:1px; }

/* â”€â”€ Connection + Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header-status-group { display:flex; align-items:center; gap:16px; }
.conn-status { display:flex; align-items:center; gap:6px; font-size:13px; letter-spacing:1px; }
.conn-dot {
  width:7px; height:7px; border-radius:50%; background:var(--accent-1);
  box-shadow:0 0 8px var(--accent-1); animation:dotBlink 2s ease-in-out infinite;
}
.conn-dot.offline { background:var(--accent-err); box-shadow:0 0 8px var(--accent-err); }
@keyframes dotBlink { 0%,100%{opacity:1} 50%{opacity:0.4} }
.proxy-dot {
  display:inline-block; width:6px; height:6px; border-radius:50%; margin-right:4px;
  background:var(--accent-1); box-shadow:0 0 6px var(--accent-1);
}
.proxy-dot.offline { background:var(--accent-err); box-shadow:0 0 6px var(--accent-err); }
.header-time { font-size:13px; color:var(--text-dim); }
.header-uptime {
  font-size:13px; color:var(--accent-1); letter-spacing:1px;
  display:flex; align-items:center; gap:5px;
}
.header-uptime-label { color:var(--text-muted); font-size:14px; letter-spacing:1.5px; text-transform:uppercase; }
.header-divider { width:1px; height:16px; background:var(--border); }

/* â”€â”€ Main & Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { padding:16px 20px; }
.page { display:none; }
.page.active { display:block; }

/* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-row {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(175px,1fr));
  gap:12px; margin-bottom:16px;
}
.stat-card {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px 16px;
  position:relative; overflow:hidden; transition:all 0.3s;
}
.stat-card:hover { border-color:var(--border-glow); box-shadow:var(--card-hover-shadow); transform:var(--card-hover-transform); }
.stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.stat-card.c1::before { background:var(--accent-1); opacity:0.7; }
.stat-card.c2::before { background:var(--accent-2); opacity:0.7; }
.stat-card.c3::before { background:var(--accent-3); opacity:0.7; }
.stat-card.c4::before { background:var(--accent-4); opacity:0.7; }
.stat-label { font-size:14px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:6px; }
.stat-value { font-size:28px; font-weight:600; line-height:1; }
.stat-value.c1 { color:var(--accent-1); text-shadow:0 0 14px var(--glow-1); }
.stat-value.c2 { color:var(--accent-2); text-shadow:0 0 14px var(--glow-2); }
.stat-value.c3 { color:var(--accent-3); }
.stat-value.c4 { color:var(--accent-4); }
.stat-sub { font-size:13px; color:var(--text-dim); margin-top:5px; }

/* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px; }
.grid-full { margin-bottom:14px; }
.panel {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden; transition:border-color 0.3s;
}
.panel-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; border-bottom:1px solid var(--border); background:var(--bg-panel-alt);
}
.panel-title { font-size:13px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); }
.panel-badge {
  font-size:14px; padding:2px 8px; border-radius:var(--radius);
  background:var(--glow-1); color:var(--accent-1); border:1px solid rgba(0,0,0,0.05);
}
.panel-body { padding:14px; }

/* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scroll-box { max-height:340px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.scroll-box::-webkit-scrollbar { width:5px; }
.scroll-box::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
table { width:100%; border-collapse:collapse; }
th {
  text-align:left; font-size:14px; letter-spacing:1.5px; text-transform:uppercase;
  color:var(--text-muted); padding:7px 10px; border-bottom:1px solid var(--border);
  position:sticky; top:0; background:var(--bg-panel); z-index:1;
}
th.sortable { cursor:pointer; user-select:none; transition:color 0.2s; }
th.sortable:hover { color:var(--accent-3); }
th.sort-asc::after { content:' â–²'; font-size:10px; }
th.sort-desc::after { content:' â–¼'; font-size:10px; }
td { padding:8px 10px; font-size:14px; border-bottom:1px solid rgba(0,0,0,0.04); color:var(--text-dim); }
tr.clickable-row { cursor:pointer; }
tr.clickable-row:hover td { background:var(--glow-1); }
tr:hover td { background:var(--glow-1); }
.td-name { color:var(--accent-3); font-weight:500; }
.td-dur { color:var(--accent-2); }
.td-dim { color:var(--text-muted); font-size:13px; }
.td-model { color:var(--accent-4); font-weight:500; font-size:12px; }
.td-tok { color:var(--accent-1); font-weight:500; }
.client-icon { margin-right:3px; }

/* â”€â”€ Load More â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.load-more-row td { text-align:center; padding:12px; }
.load-more-btn {
  background:transparent; border:1px solid var(--border); color:var(--accent-3);
  font-family:var(--font-body); font-size:13px; letter-spacing:1px;
  padding:6px 20px; border-radius:var(--radius); cursor:pointer; transition:all 0.2s;
}
.load-more-btn:hover { border-color:var(--accent-3); background:rgba(0,200,224,0.08); }

/* â”€â”€ Popup Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.popup-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
  z-index:5000; justify-content:center; align-items:center;
}
.popup-overlay.show { display:flex; }
.popup-card {
  background:var(--bg-panel); border:1px solid var(--border-glow);
  border-radius:var(--radius); padding:20px 24px; min-width:340px; max-width:480px;
  box-shadow:0 8px 32px rgba(0,0,0,0.4); position:relative;
}
.popup-close {
  position:absolute; top:10px; right:14px; background:none; border:none;
  color:var(--text-muted); font-size:18px; cursor:pointer; transition:color 0.2s;
}
.popup-close:hover { color:var(--accent-err); }
.popup-title {
  font-family:var(--font-display); font-size:14px; letter-spacing:2px;
  color:var(--accent-3); text-transform:uppercase; margin-bottom:14px;
  padding-bottom:10px; border-bottom:1px solid var(--border);
}
.popup-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.popup-item { }
.popup-label { font-size:11px; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-muted); margin-bottom:3px; }
.popup-value { font-size:15px; font-weight:500; color:var(--text-primary); }
.popup-value.accent1 { color:var(--accent-1); }
.popup-value.accent2 { color:var(--accent-2); }
.popup-value.accent3 { color:var(--accent-3); }
.popup-value.accent4 { color:var(--accent-4); }

/* â”€â”€ Status pips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pip { width:6px; height:6px; border-radius:50%; display:inline-block; margin-right:4px; }
.pip.on { background:var(--accent-1); box-shadow:0 0 6px var(--accent-1); }
.pip.off { background:var(--text-muted); }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  background:transparent; border:1px solid var(--accent-1); color:var(--accent-1);
  font-family:var(--font-body); font-size:13px; letter-spacing:1px;
  text-transform:uppercase; padding:6px 14px; border-radius:var(--radius);
  cursor:pointer; transition:all 0.2s;
}
.btn:hover { background:var(--glow-1); box-shadow:0 0 10px var(--glow-1); }
.btn:disabled { opacity:0.3; cursor:not-allowed; }
.btn.c2 { border-color:var(--accent-2); color:var(--accent-2); }
.btn.c2:hover { background:var(--glow-2); }
.btn.err { border-color:var(--accent-err); color:var(--accent-err); }
.btn.err:hover { background:rgba(255,59,74,0.08); }

/* â”€â”€ Filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar { display:flex; gap:6px; padding:10px 14px; flex-wrap:wrap; border-bottom:1px solid var(--border); }
.filter-btn {
  background:var(--bg-deep); border:1px solid var(--border); color:var(--text-dim);
  font-family:var(--font-body); font-size:14px; padding:4px 10px;
  border-radius:var(--radius); cursor:pointer; transition:all 0.2s;
}
.filter-btn:hover, .filter-btn.active { border-color:var(--accent-3); color:var(--accent-3); background:rgba(0,0,0,0.1); }

/* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input {
  background:var(--bg-deep); border:1px solid var(--border); color:var(--text-primary);
  font-family:var(--font-body); font-size:14px; padding:6px 10px;
  border-radius:var(--radius); outline:none;
}
.input:focus { border-color:var(--accent-1); }
.input-sm { width:70px; text-align:center; font-size:13px; padding:5px 8px; }

/* â”€â”€ Bench metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bench-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; }
.bench-m {
  background:var(--bg-deep); border:1px solid var(--border);
  border-radius:var(--radius); padding:12px; text-align:center;
}
.bench-m-label { font-size:14px; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-muted); margin-bottom:5px; }
.bench-m-value { font-size:24px; font-weight:600; }
.chart-wrap { position:relative; height:180px; margin-top:12px; }

/* â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.event-line { display:flex; align-items:center; gap:8px; padding:5px 0; font-size:14px; border-bottom:1px solid rgba(0,0,0,0.04); }
.event-time { color:var(--text-muted); font-size:13px; min-width:140px; }
.event-tag { font-size:14px; letter-spacing:1px; text-transform:uppercase; padding:2px 6px; border-radius:2px; font-weight:600; }
.event-tag.load { background:var(--glow-1); color:var(--accent-1); }
.event-tag.unload { background:var(--glow-2); color:var(--accent-2); }
.event-tag.warning { background:rgba(255,160,40,0.15); color:var(--accent-2); }
.event-icon { font-size:14px; min-width:20px; text-align:center; }
.event-model { color:var(--accent-3); }
.event-detail { color:var(--text-muted); font-size:12px; }

/* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* â”€â”€ Settings page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.settings-section {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px; overflow:hidden;
}
.settings-section h3 {
  font-size:13px; letter-spacing:2px; text-transform:uppercase;
  color:var(--text-dim); margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border);
}
.setting-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.04);
}
.setting-row:last-child { border-bottom:none; }
.setting-label { font-size:13px; color:var(--text-dim); }
.setting-label small { display:block; font-size:11px; color:var(--text-muted); margin-top:2px; }
.client-map-list { margin-top:8px; }
.client-map-row {
  display:flex; align-items:center; gap:6px; padding:5px 0;
  border-bottom:1px solid rgba(0,0,0,0.04); font-size:13px;
}
.client-map-row .input { flex:1; font-size:12px; padding:4px 6px; }
.client-map-row .input.ip { max-width:120px; }
.client-map-row .input.icon { max-width:40px; text-align:center; }
.client-map-row .input.name { flex:2; }
.btn-sm {
  font-size:11px; padding:3px 8px; border:1px solid var(--border);
  background:transparent; color:var(--text-dim); border-radius:var(--radius);
  cursor:pointer; transition:all 0.2s;
}
.btn-sm:hover { border-color:var(--accent-1); color:var(--accent-1); }
.btn-sm.err:hover { border-color:var(--accent-err); color:var(--accent-err); }

/* â”€â”€ API docs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.api-section { margin-bottom:12px; }
.api-endpoint {
  display:flex; align-items:center; gap:10px; padding:8px 0;
  border-bottom:1px solid rgba(0,0,0,0.04); font-size:13px; flex-wrap:wrap;
}
.api-method {
  font-size:11px; font-weight:600; letter-spacing:1px; padding:2px 8px;
  border-radius:3px; min-width:44px; text-align:center; text-transform:uppercase;
}
.api-method.get { background:var(--glow-1); color:var(--accent-1); }
.api-method.post { background:rgba(240,160,48,0.15); color:var(--accent-2); }
.api-path { color:var(--accent-3); font-weight:500; min-width:180px; }
.api-desc { color:var(--text-dim); flex:1; }
.api-desc code {
  background:var(--bg-deep); border:1px solid var(--border); border-radius:3px;
  padding:1px 5px; font-size:11px; color:var(--accent-3);
}

/* â”€â”€ Chart toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-toolbar {
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 14px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:8px;
}
.chart-toggles { display:flex; gap:4px; flex-wrap:wrap; }
.chart-toggle {
  background:var(--bg-deep); border:1px solid var(--border); color:var(--text-dim);
  font-family:var(--font-body); font-size:12px; padding:4px 10px;
  border-radius:var(--radius); cursor:pointer; transition:all 0.2s; letter-spacing:0.5px;
}
.chart-toggle:hover { border-color:var(--accent-1); color:var(--accent-1); }
.chart-toggle.active { border-color:var(--accent-1); color:var(--accent-1); background:var(--glow-1); }
.chart-filters { display:flex; gap:6px; align-items:center; }

/* â”€â”€ Update checker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.update-card {
  background:var(--bg-panel); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px; margin-bottom:14px;
}
.update-card h3 { font-size:14px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:12px; }
.pkg-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.04); font-size:14px; }
.pkg-name { color:var(--accent-3); font-weight:500; }
.pkg-ver { color:var(--text-dim); }
.pkg-new { color:var(--accent-1); font-weight:600; }
.pkg-ok { color:var(--text-muted); }
.cmd-block {
  background:var(--bg-deep); border:1px solid var(--border); border-radius:var(--radius);
  padding:12px 14px; font-size:14px; color:var(--accent-3); line-height:1.8;
  margin-top:10px; white-space:pre-wrap; position:relative;
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position:fixed; bottom:20px; right:20px; background:var(--bg-panel);
  border:1px solid var(--accent-1); color:var(--accent-1);
  padding:10px 18px; border-radius:var(--radius); font-size:14px;
  z-index:10000; opacity:0; transform:translateY(8px);
  transition:all 0.3s; pointer-events:none;
}
.toast.show { opacity:1; transform:translateY(0); }
.toast.error { border-color:var(--accent-err); color:var(--accent-err); }

/* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner {
  display:inline-block; width:12px; height:12px;
  border:2px solid var(--border); border-top-color:var(--accent-1);
  border-radius:50%; animation:spin 0.8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

.empty { text-align:center; padding:24px; font-size:14px; color:var(--text-muted); letter-spacing:1px; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* â”€â”€ Collapsible panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-header.collapsible { cursor:pointer; user-select:none; }
.panel-header.collapsible::after {
  content:'â–¼'; font-size:10px; color:var(--text-muted); transition:transform 0.2s; margin-left:8px;
}
.panel-header.collapsible.collapsed::after { transform:rotate(-90deg); }
.panel-body.collapsed, .filter-bar.collapsed { display:none; }

/* â”€â”€ Responsive: Tablet (<=900px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:900px) {
  .grid-2 { grid-template-columns:1fr; }
  .settings-grid { grid-template-columns:1fr; }
  .stats-row { grid-template-columns:repeat(2,1fr); }
  .header { flex-direction:column; gap:8px; }
  .header-status-group { flex-wrap:wrap; justify-content:center; }
}

/* â”€â”€ Responsive: Mobile (<=600px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:600px) {
  body { font-size:13px; }
  .header { padding:10px 12px; }
  .header-title { font-size:16px; letter-spacing:2px; }
  .logo-mark { width:28px; height:28px; font-size:15px; }
  .main { padding:10px 12px; }

  /* Stats: 2-column compact */
  .stats-row { grid-template-columns:repeat(2,1fr); gap:8px; }
  .stat-card { padding:10px 12px; }
  .stat-value { font-size:22px; }
  .stat-label { font-size:12px; letter-spacing:1.5px; }
  .stat-sub { font-size:11px; }

  /* Panels */
  .panel-header { padding:8px 12px; }
  .panel-body { padding:10px; }

  /* Nav tabs compact */
  .nav-tabs { gap:2px; }
  .nav-tab { padding:4px 8px; font-size:12px; }

  /* Theme controls stack */
  .theme-controls { gap:6px; }
  .theme-select { font-size:12px; padding:4px 6px; }

  /* Header status: hide dividers, compact */
  .header-divider { display:none; }
  .header-status-group { gap:8px; font-size:11px; }
  .header-right { gap:8px; }

  /* Chart toolbar wrap */
  .chart-toolbar { padding:6px 10px; }
  .chart-toggles { gap:3px; }
  .chart-toggle { font-size:11px; padding:3px 7px; }

  /* Table: compact */
  th { font-size:11px; padding:5px 6px; letter-spacing:1px; }
  td { font-size:12px; padding:6px; }
  .td-model { font-size:11px; }

  /* Hide less important columns on mobile */
  .hide-mobile { display:none; }

  /* Popup: full width on mobile */
  .popup-card { min-width:auto; max-width:calc(100vw - 32px); margin:16px; padding:16px; }
  .popup-grid { grid-template-columns:1fr; gap:8px; }
  .popup-title { font-size:13px; }

  /* Filter bar compact */
  .filter-bar { padding:6px 10px; }
  .filter-btn { font-size:12px; padding:3px 7px; }

  /* Settings compact */
  .setting-row { flex-direction:column; align-items:flex-start; gap:6px; }
  .client-map-row { flex-wrap:wrap; }
  .client-map-row .input.ip { max-width:100%; }
  .client-map-row .input.name { max-width:100%; }

  /* Bench grid compact */
  .bench-grid { grid-template-columns:repeat(2,1fr); gap:6px; }
  .bench-m { padding:8px; }
  .bench-m-value { font-size:18px; }
  .bench-m-label { font-size:12px; }
}

/* â”€â”€ Responsive: Small mobile (<=400px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:400px) {
  .stats-row { grid-template-columns:1fr 1fr; gap:6px; }
  .stat-value { font-size:18px; }
  .header-title { font-size:14px; }
  .popup-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â• -->
<div class="header">
  <div class="header-left">
    <div class="logo-mark">O</div>
    <div class="header-title">OLLAMA <span>//</span> CONTROL CENTER</div>
  </div>
  <div class="header-right">
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('dashboard',this)">Dashboard</button>
      <button class="nav-tab" onclick="showPage('updates',this)">Updates</button>
      <button class="nav-tab" onclick="showPage('settings',this)">Settings</button>
      <button class="nav-tab" onclick="showPage('api-docs',this)">API</button>
      <button class="nav-tab" id="logoutBtn" onclick="window.location='/logout'" style="display:none;">Logout</button>
    </div>
    <div class="theme-controls">
      <select class="theme-select" id="themeSelect" onchange="setTheme(this.value)">
        <option value="terminal">Terminal</option>
        <option value="cyberpunk">Cyberpunk</option>
        <option value="ocean">Ocean</option>
      </select>
      <button class="mode-toggle" id="modeToggle" onclick="toggleMode()" title="Toggle light/dark"></button>
      <span class="mode-label" id="modeLabel">DARK</span>
    </div>
    <div class="header-status-group">
      <div class="conn-status">
        <div class="conn-dot" id="connDot"></div>
        <span id="connLabel">CONNECTING</span>
      </div>
      <div class="header-divider"></div>
      <div style="font-size:12px;color:var(--text-dim);">
        <span style="color:var(--text-muted);letter-spacing:1px;">OLLAMA</span>
        <span id="ollamaVer">â€”</span>
      </div>
      <div class="header-divider"></div>
      <div style="font-size:12px;color:var(--text-dim);">
        <span style="color:var(--text-muted);letter-spacing:1px;">PROXY</span>
        <span class="proxy-dot" id="proxyDot"></span>
        <span id="proxyAddr">â€”</span>
      </div>
      <div class="header-divider"></div>
      <div class="header-uptime">
        <span class="header-uptime-label">UPTIME</span>
        <span id="ollamaUptime">â€”</span>
      </div>
      <div class="header-divider"></div>
      <div class="header-time" id="headerTime">--:--:--</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• PAGE: DASHBOARD â•â•â•â•â•â•â•â• -->
<div class="main">
<div class="page active" id="page-dashboard">

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card c1">
      <div class="stat-label">Active Model</div>
      <div class="stat-value c1" id="activeModel" style="font-size:14px;">â€”</div>
      <div class="stat-sub" id="activeModelSub">No model loaded</div>
    </div>
    <div class="stat-card c2">
      <div class="stat-label">GPU Memory</div>
      <div class="stat-value c2" id="gpuMem">â€”</div>
      <div class="stat-sub" id="gpuMemSub">VRAM usage</div>
    </div>
    <div class="stat-card c3">
      <div class="stat-label">Active Clients</div>
      <div class="stat-value c3" id="activeClients">0</div>
      <div class="stat-sub" id="activeClientsSub">No clients</div>
    </div>
    <div class="stat-card c4">
      <div class="stat-label">Total Requests</div>
      <div class="stat-value c4" id="totalReqs">0</div>
      <div class="stat-sub" id="totalReqsSub">Tracked</div>
    </div>
    <div class="stat-card c1">
      <div class="stat-label">Total Tokens</div>
      <div class="stat-value c1" id="totalTokens">0</div>
      <div class="stat-sub" id="totalTokensSub">0 in + 0 out</div>
    </div>
    <div class="stat-card c2">
      <div class="stat-label">Avg tok/s</div>
      <div class="stat-value c2" id="avgTokSec">â€”</div>
      <div class="stat-sub" id="avgTokSecSub">No data</div>
    </div>
  </div>

  <!-- Models + Benchmark -->
  <div class="grid-2">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Available Models</div>
        <div class="panel-badge" id="modelsBadge">0</div>
      </div>
      <div class="panel-body" style="padding:0;">
        <div class="scroll-box" style="max-height:300px;">
          <table><thead><tr><th>Model</th><th>Size</th><th class="hide-mobile">Quant</th><th>Status</th></tr></thead>
          <tbody id="modelsBody"><tr><td colspan="4" class="empty">Loading...</td></tr></tbody></table>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Performance Benchmark</div>
        <div class="panel-badge" id="benchBadge">0 runs</div>
      </div>
      <div class="panel-body">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
          <select class="input" id="benchModel"></select>
          <button class="btn" id="benchBtn" onclick="runBenchmark()">â–¶ Run</button>
        </div>
        <div class="bench-grid">
          <div class="bench-m"><div class="bench-m-label">Generation</div><div class="bench-m-value c1" id="brTokSec">â€”</div></div>
          <div class="bench-m"><div class="bench-m-label">Tokens</div><div class="bench-m-value c2" id="brTokens">â€”</div></div>
          <div class="bench-m"><div class="bench-m-label">Prompt Eval</div><div class="bench-m-value c3" id="brPromptRate">â€”</div></div>
          <div class="bench-m"><div class="bench-m-label">Total Time</div><div class="bench-m-value c4" id="brTotal">â€”</div></div>
        </div>
        <div class="chart-wrap"><canvas id="benchChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Request History -->
  <div class="grid-full">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Request History</div>
        <div class="panel-badge" id="histBadge">0</div>
      </div>
      <div class="filter-bar" id="filterBar">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">All Time</button>
        <button class="filter-btn" data-filter="today" onclick="setFilter('today',this)">Today</button>
        <button class="filter-btn" data-filter="7d" onclick="setFilter('7d',this)">7 Days</button>
        <button class="filter-btn" data-filter="30d" onclick="setFilter('30d',this)">30 Days</button>
        <button class="filter-btn" data-filter="6m" onclick="setFilter('6m',this)">6 Months</button>
        <button class="filter-btn" data-filter="1y" onclick="setFilter('1y',this)">Last Year</button>
        <button class="filter-btn" data-filter="ty" onclick="setFilter('ty',this)">This Year</button>
      </div>
      <div class="panel-body" style="padding:0;">
        <div class="scroll-box" id="histScroll">
          <table id="histTable">
            <thead><tr>
              <th class="sortable" data-col="time" onclick="sortBy('time',this)">Time</th>
              <th class="sortable hide-mobile" data-col="duration_ms" onclick="sortBy('duration_ms',this)">Duration</th>
              <th class="sortable" data-col="model" onclick="sortBy('model',this)">Model</th>
              <th class="sortable" data-col="prompt_tokens" onclick="sortBy('prompt_tokens',this)">In</th>
              <th class="sortable" data-col="tokens" onclick="sortBy('tokens',this)">Out</th>
              <th class="sortable" data-col="tokens_per_sec" onclick="sortBy('tokens_per_sec',this)">tok/s</th>
              <th class="sortable" data-col="client_ip" onclick="sortBy('client_ip',this)">Client</th>
            </tr></thead>
            <tbody id="histBody"><tr><td colspan="7" class="empty">No requests logged yet</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid-full">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Analytics</div>
        <div class="panel-badge" id="chartAvgTps">â€”</div>
      </div>
      <div class="chart-toolbar">
        <div class="chart-toggles">
          <button class="chart-toggle active" data-mode="tps" onclick="setChartMode('tps',this)">tok/s</button>
          <button class="chart-toggle" data-mode="tokens" onclick="setChartMode('tokens',this)">Total Tokens</button>
          <button class="chart-toggle" data-mode="inout" onclick="setChartMode('inout',this)">In vs Out</button>
          <button class="chart-toggle" data-mode="usage" onclick="setChartMode('usage',this)">Daily Usage</button>
          <button class="chart-toggle" data-mode="models" onclick="setChartMode('models',this)">By Model</button>
        </div>
        <div class="chart-filters">
          <select class="input" id="chartClientFilter" onchange="renderMainChart()" style="font-size:12px;padding:4px 8px;">
            <option value="all">All Clients</option>
          </select>
        </div>
      </div>
      <div class="panel-body">
        <div style="position:relative;height:240px;">
          <canvas id="mainChart"></canvas>
        </div>
        <div class="empty" id="mainChartEmpty" style="display:none;">Not enough data to chart</div>
      </div>
    </div>
  </div>

  <!-- Events -->
  <div class="grid-full">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Model Events</div>
        <div class="panel-badge" id="eventsBadge">0</div>
      </div>
      <div class="panel-body">
        <div class="scroll-box" style="max-height:200px;" id="eventsBody">
          <div class="empty">No events recorded yet</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• PAGE: UPDATES â•â•â•â•â•â•â•â• -->
<div class="page" id="page-updates">
  <div class="update-card">
    <h3>Dashboard Packages</h3>
    <div id="pkgList"><div class="empty">Click "Check for Updates" to scan</div></div>
  </div>
  <div class="update-card">
    <h3>Ollama-Intel Base Image</h3>
    <div id="imageInfo"><div class="empty">Click "Check for Updates" to scan</div></div>
  </div>
  <div class="update-card">
    <h3>Rebuild Commands</h3>
    <p style="font-size:14px;color:var(--text-dim);margin-bottom:10px;">Copy and paste these into your Unraid terminal to update.</p>
    <div style="font-size:13px;letter-spacing:1px;color:var(--text-muted);margin-bottom:6px;">DASHBOARD CONTAINER:</div>
    <div class="cmd-block" id="cmdDash">cd /mnt/user/appdata/ollama-dashboard-build
docker pull python:3.11-slim
docker build --no-cache -t ollama-dashboard .
# Then restart from Unraid Docker tab</div>
    <div style="font-size:13px;letter-spacing:1px;color:var(--text-muted);margin:14px 0 6px;">OLLAMA-INTEL CONTAINER:</div>
    <div class="cmd-block" id="cmdOllama">cd /mnt/user/appdata/ollama-build
docker pull intelanalytics/ipex-llm-inference-cpp-xpu:latest
docker build --no-cache -t ollama-intel .
# Then restart from Unraid Docker tab</div>
  </div>
  <div style="margin-top:14px;">
    <button class="btn" id="updateBtn" onclick="checkUpdates()">âŸ³ Check for Updates</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• PAGE: SETTINGS â•â•â•â•â•â•â•â• -->
<div class="page" id="page-settings">
  <div class="settings-grid">
    <!-- Client Mapping -->
    <div class="settings-section" style="grid-column:1/-1;">
      <h3>Client Mapping</h3>
      <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">Map client IPs to friendly names with emoji icons. These appear in request history and charts.</p>
      <div class="client-map-list" id="clientMapList"></div>
      <div style="margin-top:8px;display:flex;gap:6px;">
        <button class="btn-sm" onclick="addClientRow()">+ Add Client</button>
      </div>
    </div>

    <!-- Poll & Retention -->
    <div class="settings-section">
      <h3>Polling & Data</h3>
      <div class="setting-row">
        <div class="setting-label">Poll Interval<small>How often to check Ollama status (seconds)</small></div>
        <input type="number" class="input input-sm" id="setPollInterval" min="1" max="60" value="5">
      </div>
      <div class="setting-row">
        <div class="setting-label">Auto-trim Retention<small>Auto-delete history older than this</small></div>
        <select class="input" id="setRetention" style="font-size:12px;padding:4px 8px;">
          <option value="0">Disabled</option>
          <option value="1">1 month</option>
          <option value="3">3 months</option>
          <option value="6" selected>6 months</option>
          <option value="12">12 months</option>
          <option value="24">24 months</option>
        </select>
      </div>
    </div>

    <!-- Appearance -->
    <div class="settings-section">
      <h3>Appearance</h3>
      <div class="setting-row">
        <div class="setting-label">Save theme to server<small>Theme/mode persists across browsers</small></div>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="checkbox" id="setSyncTheme" style="cursor:pointer;">
          <span style="font-size:12px;color:var(--text-dim);">Sync</span>
        </label>
      </div>
      <div class="setting-row">
        <div class="setting-label">Dashboard version</div>
        <span style="font-size:13px;color:var(--accent-3);">v1.0</span>
      </div>
    </div>

    <!-- Data Management -->
    <div class="settings-section" style="grid-column:1/-1;">
      <h3>Data Management</h3>
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;" id="histFileInfo">â€”</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
        <span class="setting-label" style="min-width:auto;">Trim by count:</span>
        <input type="number" class="input input-sm" id="trimCount" value="500" min="10">
        <button class="btn-sm" onclick="trimByCount()">Trim</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
        <span class="setting-label" style="min-width:auto;">Trim by age:</span>
        <select class="input" id="trimMonths" style="font-size:12px;padding:4px 8px;">
          <option value="1">1 month</option>
          <option value="3">3 months</option>
          <option value="6" selected>6 months</option>
          <option value="12">12 months</option>
          <option value="24">24 months</option>
        </select>
        <button class="btn-sm" onclick="trimByTime()">Trim</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px;">
        <button class="btn" onclick="exportHistory()">Export History</button>
        <button class="btn" onclick="generateSnapshot()">ğŸ“¸ Snapshot</button>
        <button class="btn err" onclick="clearHistory()">Clear All</button>
      </div>
    </div>
  </div>

  <div style="margin-top:14px;display:flex;gap:8px;">
    <button class="btn" onclick="saveSettings()">Save Settings</button>
    <button class="btn c2" onclick="loadSettingsUI()">Reset</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• PAGE: API DOCS â•â•â•â•â•â•â•â• -->
<div class="page" id="page-api-docs">
  <div class="settings-section" style="max-width:800px;">
    <h3>API Documentation</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;">
      All endpoints return JSON. When password protection is enabled, requests require a valid session cookie.
      The proxy on port 11434 forwards to Ollama and is <strong>not</strong> password-protected (clients like Open WebUI connect directly).
    </p>

    <div class="api-section">
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/status</span>
        <span class="api-desc">Ollama connection status, running models, GPU memory, versions</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/history</span>
        <span class="api-desc">Full history â€” requests, benchmarks, and model events</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/history/stats</span>
        <span class="api-desc">Summary counts and history file size</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/history/export</span>
        <span class="api-desc">Download full history as JSON file</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">/api/benchmark</span>
        <span class="api-desc">Run a benchmark on a model â€” body: <code>{"model": "name"}</code></span>
      </div>
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">/api/trim</span>
        <span class="api-desc">Trim history â€” body: <code>{"mode": "count", "keep": 500}</code> or <code>{"mode": "time", "months": 6}</code></span>
      </div>
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">/api/clear</span>
        <span class="api-desc">Delete all history data</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/settings</span>
        <span class="api-desc">Current dashboard settings</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">/api/settings</span>
        <span class="api-desc">Save settings â€” body: <code>{"poll_interval": 5, "client_map": {...}}</code></span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/client-map</span>
        <span class="api-desc">Active client IP-to-name mapping</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/api/updates</span>
        <span class="api-desc">Check for package and base image updates</span>
      </div>
    </div>

    <h3 style="margin-top:20px;">Proxy Endpoints</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;">
      The proxy on port <strong>11434</strong> forwards all Ollama API requests and records token metrics.
      Point your clients here instead of directly at Ollama for full tracking.
    </p>
    <div class="api-section">
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">:11434/api/chat</span>
        <span class="api-desc">Proxied chat completions (tokens tracked)</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">:11434/api/generate</span>
        <span class="api-desc">Proxied text generation (tokens tracked)</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method">*</span>
        <span class="api-path">:11434/*</span>
        <span class="api-desc">All other Ollama endpoints pass through transparently</span>
      </div>
    </div>

    <h3 style="margin-top:20px;">Authentication</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;" id="authDocInfo">
      Password protection is <strong>disabled</strong>. Set <code>DASHBOARD_PASSWORD</code> env var to enable.
    </p>
    <div class="api-section" id="authDocEndpoints" style="display:none;">
      <div class="api-endpoint">
        <span class="api-method post">POST</span>
        <span class="api-path">/login</span>
        <span class="api-desc">Authenticate â€” body: <code>{"password": "..."}</code> â†’ sets session cookie</span>
      </div>
      <div class="api-endpoint">
        <span class="api-method get">GET</span>
        <span class="api-path">/logout</span>
        <span class="api-desc">Clear session and redirect to login</span>
      </div>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â• POPUP â•â•â•â•â•â•â•â• -->
<div class="popup-overlay" id="popupOverlay" onclick="closePopup(event)">
  <div class="popup-card" onclick="event.stopPropagation()">
    <button class="popup-close" onclick="document.getElementById('popupOverlay').classList.remove('show')">âœ•</button>
    <div class="popup-title" id="popupTitle">Request Details</div>
    <div class="popup-grid" id="popupGrid"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â• -->
<script>
const API = window.location.origin;
let benchChart = null;
let allHistory = { requests:[], benchmarks:[], events:[] };
let currentFilter = 'all';
let sortState = { col: 'time', dir: 'desc' };
const pageSize = 50;
let currentPageCount = 50;
let ollamaStartTime = null;
let chartMode = 'tps';
let mainChartInstance = null;

// â”€â”€ Client Name Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Auto-populated from server config, or add your own mappings
let CLIENT_MAP = {};
// Fetch client map from server
async function loadClientMap() {
  try {
    const r = await fetch(`${API}/api/client-map`);
    if (r.ok) CLIENT_MAP = await r.json();
  } catch(e) {}
}
loadClientMap();
function getClient(ip) {
  if (!ip) return { name:'Unknown', icon:'â“', ip:'' };
  const mapped = CLIENT_MAP[ip];
  if (mapped) return { ...mapped, ip };
  return { name:ip, icon:'ğŸ¤–', ip };
}

// â”€â”€ Theme System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('ollama-theme', theme);
  if (benchChart) rebuildChart();
  renderMainChart();
}
function toggleMode() {
  const html = document.documentElement;
  const mode = html.getAttribute('data-mode') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-mode', mode);
  localStorage.setItem('ollama-mode', mode);
  document.getElementById('modeLabel').textContent = mode.toUpperCase();
  if (benchChart) rebuildChart();
  renderMainChart();
}
function loadThemePrefs() {
  const t = localStorage.getItem('ollama-theme') || 'terminal';
  const m = localStorage.getItem('ollama-mode') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  document.documentElement.setAttribute('data-mode', m);
  document.getElementById('themeSelect').value = t;
  document.getElementById('modeLabel').textContent = m.toUpperCase();
}
loadThemePrefs();

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtBytes(b) {
  if (!b) return '0 B';
  const u=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(b)/Math.log(1024));
  return (b/Math.pow(1024,i)).toFixed(1)+' '+u[i];
}
function fmtDur(ms) {
  if(ms<1000) return ms.toFixed(0)+'ms';
  const s = ms/1000;
  if(s<60) return s>=1 ? Math.round(s)+'s' : s.toFixed(1)+'s';
  return (ms/60000).toFixed(1)+'m';
}
function fmtTime(iso) {
  try { const d=new Date(iso); return d.toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
  catch { return iso; }
}
function fmtNum(n) {
  if(n>=1000000) return (n/1000000).toFixed(1)+'M';
  if(n>=1000) return (n/1000).toFixed(1)+'K';
  return n.toString();
}
function showToast(msg, err) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=err?'toast error show':'toast show';
  setTimeout(()=>t.className='toast', 3000);
}
function fmtUptime(ms) {
  const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60);
  return `${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

// â”€â”€ Clock + Ollama Uptime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick() {
  const now=new Date();
  document.getElementById('headerTime').textContent=now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(ollamaStartTime) {
    document.getElementById('ollamaUptime').textContent = fmtUptime(Date.now() - ollamaStartTime);
  }
}
setInterval(tick,1000); tick();

// â”€â”€ History Filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFilterCutoff(filter) {
  const now = new Date();
  switch(filter) {
    case 'today': return new Date(now.getFullYear(),now.getMonth(),now.getDate()).toISOString();
    case '7d': return new Date(now-7*86400000).toISOString();
    case '30d': return new Date(now-30*86400000).toISOString();
    case '6m': return new Date(now.getFullYear(),now.getMonth()-6,now.getDate()).toISOString();
    case '1y': return new Date(now-365*86400000).toISOString();
    case 'ty': return new Date(now.getFullYear(),0,1).toISOString();
    default: return null;
  }
}
function filterEntries(entries, filter) {
  const cutoff = getFilterCutoff(filter);
  if (!cutoff) return entries;
  return entries.filter(e => (e.time||'') >= cutoff);
}
function setFilter(f, el) {
  currentFilter = f;
  currentPageCount = pageSize;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderHistory();
}

// â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortBy(col, thEl) {
  if (sortState.col === col) {
    sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
  } else {
    sortState.col = col;
    sortState.dir = 'desc';
  }
  document.querySelectorAll('#histTable th').forEach(th => {
    th.classList.remove('sort-asc','sort-desc');
  });
  thEl.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
  renderHistory();
}

function sortEntries(entries) {
  const col = sortState.col;
  const dir = sortState.dir === 'asc' ? 1 : -1;
  return entries.slice().sort((a,b) => {
    let va = a[col], vb = b[col];
    if (col === 'time') {
      va = va || ''; vb = vb || '';
      return va < vb ? -dir : va > vb ? dir : 0;
    }
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * dir;
    va = String(va||'').toLowerCase(); vb = String(vb||'').toLowerCase();
    return va < vb ? -dir : va > vb ? dir : 0;
  });
}

// â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPopup(idx) {
  const filtered = filterEntries(allHistory.requests||[], currentFilter);
  const sorted = sortEntries(filtered);
  const r = sorted[idx];
  if (!r) return;
  const client = getClient(r.client_ip);
  const items = [
    { label:'Time', value:fmtTime(r.time), cls:'' },
    { label:'Client', value:`${client.icon} ${client.name} (${r.client_ip||'?'})`, cls:'accent3' },
    { label:'Endpoint', value:r.path||'â€”', cls:'accent3' },
    { label:'Method', value:r.method||'â€”', cls:'' },
    { label:'Model', value:r.model||'â€”', cls:'accent4' },
    { label:'Duration', value:r.duration||'â€”', cls:'accent2' },
    { label:'In Tokens', value:r.prompt_tokens||0, cls:'accent1' },
    { label:'Out Tokens', value:r.tokens||0, cls:'accent1' },
    { label:'Total Tokens', value:r.total_tokens||0, cls:'accent1' },
    { label:'Gen Speed', value:(r.tokens_per_sec ? r.tokens_per_sec.toFixed(1)+' tok/s' : 'â€”'), cls:'accent2' },
    { label:'Prompt Speed', value:(r.prompt_tok_per_sec ? r.prompt_tok_per_sec.toFixed(1)+' tok/s' : 'â€”'), cls:'accent2' },
    { label:'Source', value:r.source==='proxy' ? 'â¬¡ Proxy' : 'Direct', cls:'' },
  ];
  if (r.done_reason) items.push({ label:'Done Reason', value:r.done_reason, cls:'' });

  document.getElementById('popupTitle').textContent = `${client.icon} ${r.model || 'Request'} â€” ${fmtTime(r.time)}`;
  document.getElementById('popupGrid').innerHTML = items.map(i =>
    `<div class="popup-item"><div class="popup-label">${i.label}</div><div class="popup-value ${i.cls}">${i.value}</div></div>`
  ).join('');
  document.getElementById('popupOverlay').classList.add('show');
}
function closePopup(e) {
  if (e.target.id === 'popupOverlay') {
    document.getElementById('popupOverlay').classList.remove('show');
  }
}
// Close popup on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('popupOverlay').classList.remove('show');
});

// â”€â”€ Fetch Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStatus() {
  try {
    const r = await fetch(`${API}/api/status`);
    const d = await r.json();
    const dot=document.getElementById('connDot'), lbl=document.getElementById('connLabel');
    if(d.status==='online'){ dot.className='conn-dot'; lbl.textContent='ONLINE'; }
    else { dot.className='conn-dot offline'; lbl.textContent='OFFLINE'; }

    // Ollama version
    document.getElementById('ollamaVer').textContent=d.ollama_version||'â€”';

    // Proxy IP:port with status dot
    const proxyDot = document.getElementById('proxyDot');
    const proxyAddr = document.getElementById('proxyAddr');
    if(d.proxy_ip && d.proxy_port) {
      proxyAddr.textContent = d.proxy_ip + ':' + d.proxy_port;
      proxyDot.className = 'proxy-dot';
    } else {
      proxyAddr.textContent = 'â€”';
      proxyDot.className = 'proxy-dot offline';
    }

    // Ollama uptime â€” use dashboard_start as proxy for container start
    if(d.dashboard_start && !ollamaStartTime) {
      ollamaStartTime = new Date(d.dashboard_start).getTime();
    }

    const running = d.running?.models||[];
    const details = d.model_details||[];
    const el=document.getElementById('activeModel'), sub=document.getElementById('activeModelSub');
    if(running.length>0) {
      const m=running[0]; el.textContent=m.name||'â€”';
      const det=details.length>0?details[0]:{};
      const parts=[];
      if(det.parameter_size) parts.push(det.parameter_size);
      if(det.quantization) parts.push(det.quantization);
      if(det.family) parts.push(det.family);
      sub.textContent=parts.length>0 ? parts.join(' Â· ') : 'Loaded';
      const vram=m.size_vram||m.size||0;
      document.getElementById('gpuMem').textContent=fmtBytes(vram);
      document.getElementById('gpuMemSub').textContent=running.length+' model(s) loaded';
    } else {
      el.textContent='â€”'; sub.textContent='No model loaded';
      document.getElementById('gpuMem').textContent='0';
      document.getElementById('gpuMemSub').textContent='Idle';
    }

    const models=d.models?.models||[];
    const runNames=new Set(running.map(m=>m.name));
    document.getElementById('modelsBadge').textContent=models.length;

    const tb=document.getElementById('modelsBody');
    if(!models.length){ tb.innerHTML='<tr><td colspan="4" class="empty">No models installed</td></tr>'; }
    else {
      tb.innerHTML=models.map(m=>{
        const a=runNames.has(m.name);
        return `<tr><td class="td-name">${m.name}</td><td class="td-dim">${fmtBytes(m.size)}</td>
        <td class="td-dim hide-mobile">${m.details?.quantization_level||'â€”'}</td>
        <td><span class="pip ${a?'on':'off'}"></span><span style="font-size:13px;letter-spacing:1px;color:${a?'var(--accent-1)':'var(--text-muted)'}">${a?'LOADED':'IDLE'}</span></td></tr>`;
      }).join('');
    }

    const sel=document.getElementById('benchModel');
    const cv=sel.value;
    sel.innerHTML=models.map(m=>`<option value="${m.name}" ${m.name===cv?'selected':''}>${m.name}</option>`).join('');
  } catch(e) {
    document.getElementById('connDot').className='conn-dot offline';
    document.getElementById('connLabel').textContent='ERROR';
  }
}

// â”€â”€ Fetch & Render History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastHistoryHash = '';

function historyHash(h) {
  const r = h.requests||[], e = h.events||[];
  return `${r.length}:${e.length}:${r.length ? r[r.length-1].time||'' : ''}`;
}

async function fetchHistory() {
  try {
    const r=await fetch(`${API}/api/history`);
    const data=await r.json();
    const hash = historyHash(data);
    const changed = hash !== lastHistoryHash;
    lastHistoryHash = hash;
    allHistory = data;
    if (changed) renderHistory();
    const sr=await fetch(`${API}/api/history/stats`);
    const sd=await sr.json();
    document.getElementById('histFileInfo').textContent=
      `Reqs: ${sd.requests} | Bench: ${sd.benchmarks} | Events: ${sd.events} | File: ${sd.file_size}`;
  } catch(e){}
}

function setChartMode(mode, el) {
  chartMode = mode;
  document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderMainChart();
}

function getChartThemeColors() {
  const s = getComputedStyle(document.documentElement);
  return {
    accent1: s.getPropertyValue('--accent-1').trim(),
    accent2: s.getPropertyValue('--accent-2').trim(),
    accent3: s.getPropertyValue('--accent-3').trim(),
    accent4: s.getPropertyValue('--accent-4').trim(),
    dim: s.getPropertyValue('--text-dim').trim(),
    muted: s.getPropertyValue('--text-muted').trim(),
    border: s.getPropertyValue('--border').trim(),
    panel: s.getPropertyValue('--bg-panel').trim(),
  };
}

function getFilteredChartData() {
  const filtered = filterEntries(allHistory.requests||[], currentFilter);
  const sorted = sortEntries(filtered);
  const clientFilter = document.getElementById('chartClientFilter')?.value || 'all';
  let data = sorted.slice().reverse(); // chronological
  if (clientFilter !== 'all') {
    data = data.filter(r => r.client_ip === clientFilter);
  }
  return data;
}

function updateClientDropdown(reqs) {
  const sel = document.getElementById('chartClientFilter');
  const prev = sel.value;
  const ips = [...new Set(reqs.map(r=>r.client_ip).filter(Boolean))];
  let html = '<option value="all">All Clients</option>';
  ips.forEach(ip => {
    const c = getClient(ip);
    html += `<option value="${ip}" ${ip===prev?'selected':''}>${c.icon} ${c.name}</option>`;
  });
  sel.innerHTML = html;
}

function renderMainChart() {
  const canvas = document.getElementById('mainChart');
  const emptyMsg = document.getElementById('mainChartEmpty');
  const badge = document.getElementById('chartAvgTps');
  const c = getChartThemeColors();

  const data = getFilteredChartData();
  const proxied = data.filter(r => r.source==='proxy' && r.tokens_per_sec > 0);

  // Destroy old chart
  if (mainChartInstance) { mainChartInstance.destroy(); mainChartInstance = null; }

  if (chartMode === 'models') {
    return renderModelsChart(canvas, emptyMsg, badge, data, c);
  }
  if (chartMode === 'usage') {
    return renderUsageChart(canvas, emptyMsg, badge, data, c);
  }

  // Line chart modes: tps, tokens, inout
  let points, datasets, yLabel, badgeText;

  if (chartMode === 'tps') {
    points = proxied;
    if (points.length < 2) {
      canvas.style.display='none'; emptyMsg.style.display='block';
      badge.textContent = 'â€”'; return;
    }
    const vals = points.map(p=>p.tokens_per_sec);
    const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
    const peak = Math.max(...vals);
    badgeText = `avg ${avg.toFixed(1)} Â· peak ${peak.toFixed(1)} tok/s`;
    datasets = [{
      label:'tok/s', data:vals, borderColor:c.accent1,
      backgroundColor:c.accent1+'18', fill:true, tension:0.3,
      pointRadius:points.length>50?0:3, pointHoverRadius:5, borderWidth:2
    }];
    yLabel = 'tok/s';
  } else if (chartMode === 'tokens') {
    points = data.filter(r=>r.total_tokens>0);
    if (points.length < 2) {
      canvas.style.display='none'; emptyMsg.style.display='block';
      badge.textContent = 'â€”'; return;
    }
    const vals = points.map(p=>p.total_tokens||0);
    const total = vals.reduce((a,b)=>a+b,0);
    badgeText = `${fmtNum(total)} total tokens`;
    datasets = [{
      label:'Total Tokens', data:vals, borderColor:c.accent3,
      backgroundColor:c.accent3+'18', fill:true, tension:0.3,
      pointRadius:points.length>50?0:3, pointHoverRadius:5, borderWidth:2
    }];
    yLabel = 'tokens';
  } else if (chartMode === 'inout') {
    points = data.filter(r=>(r.prompt_tokens>0)||(r.tokens>0));
    if (points.length < 2) {
      canvas.style.display='none'; emptyMsg.style.display='block';
      badge.textContent = 'â€”'; return;
    }
    const totalIn = points.reduce((s,r)=>s+(r.prompt_tokens||0),0);
    const totalOut = points.reduce((s,r)=>s+(r.tokens||0),0);
    badgeText = `${fmtNum(totalIn)} in Â· ${fmtNum(totalOut)} out`;
    datasets = [
      { label:'In (prompt)', data:points.map(p=>p.prompt_tokens||0), borderColor:c.accent3,
        backgroundColor:c.accent3+'18', fill:true, tension:0.3, pointRadius:0, pointHoverRadius:4, borderWidth:2 },
      { label:'Out (generated)', data:points.map(p=>p.tokens||0), borderColor:c.accent1,
        backgroundColor:c.accent1+'18', fill:true, tension:0.3, pointRadius:0, pointHoverRadius:4, borderWidth:2 }
    ];
    yLabel = 'tokens';
  }

  canvas.style.display='block'; emptyMsg.style.display='none';
  badge.textContent = badgeText;

  const labels = points.map(p => {
    try { return new Date(p.time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}); }
    catch { return '?'; }
  });

  mainChartInstance = new Chart(canvas, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ display:datasets.length>1, labels:{ color:c.dim, font:{family:'JetBrains Mono',size:11}, usePointStyle:true, pointStyle:'line' }},
        tooltip:{
          backgroundColor:c.panel, borderColor:c.border, borderWidth:1,
          titleFont:{family:'JetBrains Mono',size:11}, bodyFont:{family:'JetBrains Mono',size:12},
          titleColor:c.dim, bodyColor:c.accent1, padding:10,
          callbacks:{
            title: items => {
              const idx = items[0]?.dataIndex;
              if (idx!==undefined && points[idx]) return fmtTime(points[idx].time);
              return '';
            },
            afterBody: items => {
              const idx = items[0]?.dataIndex;
              if (idx!==undefined && points[idx]) {
                const r = points[idx];
                const client = getClient(r.client_ip);
                const lines = [`${client.icon} ${client.name}`];
                if (r.model) lines.push(`Model: ${r.model}`);
                return lines;
              }
              return [];
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:c.muted, font:{family:'JetBrains Mono',size:9}, maxTicksLimit:8, maxRotation:0},
          grid:{color:c.border+'40'}},
        y:{ticks:{color:c.muted, font:{family:'JetBrains Mono',size:9}, callback:v=>chartMode==='tps'?v+' t/s':fmtNum(v)},
          grid:{color:c.border+'40'}}
      }
    }
  });
}

function renderUsageChart(canvas, emptyMsg, badge, data, c) {
  const withTokens = data.filter(r=>(r.prompt_tokens>0)||(r.tokens>0));
  if (withTokens.length < 1) {
    canvas.style.display='none'; emptyMsg.style.display='block';
    badge.textContent='â€”'; return;
  }

  // Group by day
  const days = {};
  withTokens.forEach(r => {
    const day = (r.time||'').substring(0,10); // YYYY-MM-DD
    if (!days[day]) days[day] = { in:0, out:0 };
    days[day].in += r.prompt_tokens||0;
    days[day].out += r.tokens||0;
  });

  const sortedDays = Object.keys(days).sort();
  if (sortedDays.length < 1) {
    canvas.style.display='none'; emptyMsg.style.display='block';
    badge.textContent='â€”'; return;
  }

  const totalIn = sortedDays.reduce((s,d)=>s+days[d].in,0);
  const totalOut = sortedDays.reduce((s,d)=>s+days[d].out,0);
  badge.textContent = `${fmtNum(totalIn)} in Â· ${fmtNum(totalOut)} out over ${sortedDays.length} days`;
  canvas.style.display='block'; emptyMsg.style.display='none';

  const labels = sortedDays.map(d => {
    try { const dt=new Date(d+'T00:00:00'); return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
    catch { return d; }
  });

  mainChartInstance = new Chart(canvas, {
    type:'bar',
    data:{
      labels,
      datasets:[
        { label:'In (prompt)', data:sortedDays.map(d=>days[d].in), backgroundColor:c.accent3+'99', borderColor:c.accent3, borderWidth:1 },
        { label:'Out (generated)', data:sortedDays.map(d=>days[d].out), backgroundColor:c.accent1+'99', borderColor:c.accent1, borderWidth:1 }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ display:true, labels:{ color:c.dim, font:{family:'JetBrains Mono',size:11}, usePointStyle:true, pointStyle:'rect' }},
        tooltip:{
          backgroundColor:c.panel, borderColor:c.border, borderWidth:1,
          titleFont:{family:'JetBrains Mono',size:11}, bodyFont:{family:'JetBrains Mono',size:12},
          titleColor:c.dim, bodyColor:c.accent1, padding:10
        }
      },
      scales:{
        x:{ stacked:true, ticks:{color:c.muted, font:{family:'JetBrains Mono',size:9}, maxRotation:0}, grid:{color:c.border+'40'} },
        y:{ stacked:true, ticks:{color:c.muted, font:{family:'JetBrains Mono',size:9}, callback:v=>fmtNum(v)}, grid:{color:c.border+'40'} }
      }
    }
  });
}

function renderModelsChart(canvas, emptyMsg, badge, data, c) {
  const proxied = data.filter(r => r.source==='proxy' && r.tokens_per_sec > 0 && r.model);
  if (proxied.length < 1) {
    canvas.style.display='none'; emptyMsg.style.display='block';
    badge.textContent='â€”'; return;
  }

  // Group by model
  const models = {};
  proxied.forEach(r => {
    if (!models[r.model]) models[r.model] = { sum:0, count:0, peak:0 };
    models[r.model].sum += r.tokens_per_sec;
    models[r.model].count++;
    models[r.model].peak = Math.max(models[r.model].peak, r.tokens_per_sec);
  });

  const names = Object.keys(models).sort((a,b) => (models[b].sum/models[b].count) - (models[a].sum/models[a].count));
  const avgs = names.map(n => models[n].sum / models[n].count);
  const peaks = names.map(n => models[n].peak);

  badge.textContent = `${names.length} model(s) compared`;
  canvas.style.display='block'; emptyMsg.style.display='none';

  const colors = [c.accent1, c.accent3, c.accent2, c.accent4, '#ff6b9d', '#c084fc'];

  mainChartInstance = new Chart(canvas, {
    type:'bar',
    data:{
      labels: names.map(n => n.length > 20 ? n.substring(0,18)+'â€¦' : n),
      datasets:[
        { label:'Avg tok/s', data:avgs, backgroundColor:names.map((_,i) => (colors[i%colors.length])+'99'),
          borderColor:names.map((_,i) => colors[i%colors.length]), borderWidth:1 },
        { label:'Peak tok/s', data:peaks, backgroundColor:names.map((_,i) => (colors[i%colors.length])+'33'),
          borderColor:names.map((_,i) => colors[i%colors.length]), borderWidth:1, borderDash:[3,3] }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      plugins:{
        legend:{ display:true, labels:{ color:c.dim, font:{family:'JetBrains Mono',size:11}, usePointStyle:true, pointStyle:'rect' }},
        tooltip:{
          backgroundColor:c.panel, borderColor:c.border, borderWidth:1,
          titleFont:{family:'JetBrains Mono',size:11}, bodyFont:{family:'JetBrains Mono',size:12},
          titleColor:c.dim, bodyColor:c.accent1, padding:10,
          callbacks:{
            afterBody: items => {
              const idx = items[0]?.dataIndex;
              if (idx!==undefined) return [`Runs: ${models[names[idx]].count}`];
              return [];
            }
          }
        }
      },
      scales:{
        x:{ ticks:{color:c.muted, font:{family:'JetBrains Mono',size:9}, callback:v=>v+' t/s'}, grid:{color:c.border+'40'} },
        y:{ ticks:{color:c.dim, font:{family:'JetBrains Mono',size:10}}, grid:{display:false} }
      }
    }
  });
}

function renderHistory() {
  const filtered = filterEntries(allHistory.requests||[], currentFilter);
  const sorted = sortEntries(filtered);

  document.getElementById('totalReqs').textContent=sorted.length;
  document.getElementById('totalReqsSub').textContent=sorted.length+' tracked';
  document.getElementById('histBadge').textContent=sorted.length;

  // Filtered token totals
  const filteredIn = sorted.reduce((s,r)=>s+(r.prompt_tokens||0),0);
  const filteredOut = sorted.reduce((s,r)=>s+(r.tokens||0),0);
  document.getElementById('totalTokens').textContent=fmtNum(filteredIn+filteredOut);
  document.getElementById('totalTokensSub').textContent=
    `${fmtNum(filteredIn)} in + ${fmtNum(filteredOut)} out`;

  // Active clients
  const uniqueIPs = new Set(sorted.map(r=>r.client_ip).filter(Boolean));
  document.getElementById('activeClients').textContent = uniqueIPs.size;
  const clientNames = [...uniqueIPs].map(ip => { const c=getClient(ip); return c.icon+' '+c.name; });
  document.getElementById('activeClientsSub').textContent = clientNames.length > 0 ? clientNames.slice(0,3).join(', ') : 'No clients';

  // Avg tok/s
  const proxiedWithSpeed = sorted.filter(r => r.source==='proxy' && r.tokens_per_sec > 0);
  if (proxiedWithSpeed.length > 0) {
    const avgTps = proxiedWithSpeed.reduce((s,r) => s+r.tokens_per_sec, 0) / proxiedWithSpeed.length;
    const peakTps = Math.max(...proxiedWithSpeed.map(r => r.tokens_per_sec));
    document.getElementById('avgTokSec').textContent = avgTps.toFixed(1);
    document.getElementById('avgTokSecSub').textContent = `Peak: ${peakTps.toFixed(1)} tok/s`;
  } else {
    document.getElementById('avgTokSec').textContent = 'â€”';
    document.getElementById('avgTokSecSub').textContent = 'No proxy data';
  }

  // Render table with pagination
  const hb=document.getElementById('histBody');
  const visible = sorted.slice(0, currentPageCount);
  const hasMore = sorted.length > currentPageCount;

  if(!sorted.length) {
    hb.innerHTML='<tr><td colspan="7" class="empty">No requests in this period</td></tr>';
  } else {
    let rows = visible.map((r,i) => {
      const client = getClient(r.client_ip);
      const inTok = (r.prompt_tokens && r.prompt_tokens > 0) ? r.prompt_tokens : 'â€”';
      const outTok = (r.tokens && r.tokens > 0) ? r.tokens : 'â€”';
      const tps = (r.tokens_per_sec && r.tokens_per_sec > 0) ? r.tokens_per_sec.toFixed(1) : 'â€”';
      return `<tr class="clickable-row" onclick="showPopup(${i})">
        <td class="td-dim">${fmtTime(r.time)}</td>
        <td class="td-dur hide-mobile">${r.duration||'â€”'}</td>
        <td class="td-model">${r.model||'â€”'}</td>
        <td class="td-tok">${inTok}</td>
        <td class="td-tok">${outTok}</td>
        <td class="td-dur">${tps}</td>
        <td class="td-dim"><span class="client-icon">${client.icon}</span>${client.name}</td>
      </tr>`;
    }).join('');

    if (hasMore) {
      rows += `<tr class="load-more-row"><td colspan="7">
        <button class="load-more-btn" onclick="loadMore()">Load more (${sorted.length - currentPageCount} remaining)</button>
      </td></tr>`;
    }
    hb.innerHTML = rows;
  }

  // Update chart client dropdown and render chart
  updateClientDropdown(sorted);
  renderMainChart();

  // Events
  const events=(allHistory.events||[]).slice().reverse();
  document.getElementById('eventsBadge').textContent=events.length;
  const eb=document.getElementById('eventsBody');
  if(!events.length){ eb.innerHTML='<div class="empty">No events recorded yet</div>'; }
  else {
    const eventIcons = { load:'ğŸŸ¢', unload:'ğŸ”´', warning:'âš ï¸', error:'âŒ' };
    eb.innerHTML=events.slice(0,100).map(e=>{
      const icon = eventIcons[e.type] || 'âšª';
      const detail = e.detail ? `<span class="event-detail">${e.detail}</span>` : '';
      return `<div class="event-line">
        <span class="event-icon">${icon}</span>
        <span class="event-time">${fmtTime(e.time)}</span>
        <span class="event-tag ${e.type}">${e.type}</span>
        <span class="event-model">${e.model||'â€”'}</span>
        ${detail}
      </div>`;
    }).join('');
  }

  // Benchmarks
  const benches=allHistory.benchmarks||[];
  document.getElementById('benchBadge').textContent=benches.length+' runs';
  if(benches.length>0){
    const last=benches[benches.length-1];
    document.getElementById('brTokSec').textContent=(last.tokens_per_sec?.toFixed(1)||'â€”')+' t/s';
    document.getElementById('brTokens').textContent=last.eval_count||'â€”';
    document.getElementById('brPromptRate').textContent=(last.prompt_eval_rate?.toFixed(1)||'â€”')+' t/s';
    document.getElementById('brTotal').textContent=fmtDur(last.total_duration_ms||0);
  }
  updateChart(benches);
}

function loadMore() {
  currentPageCount += pageSize;
  renderHistory();
}

// â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getChartColor() {
  return getComputedStyle(document.documentElement).getPropertyValue('--accent-1').trim();
}
function rebuildChart() {
  if(benchChart){benchChart.destroy();benchChart=null;}
  updateChart(allHistory.benchmarks||[]);
}
function updateChart(benches) {
  const ctx=document.getElementById('benchChart');
  if(!ctx) return;
  const labels=benches.map(b=>{try{return new Date(b.time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});}catch{return '?';}});
  const data=benches.map(b=>b.tokens_per_sec||0);
  const c=getChartColor();

  if(benchChart){
    benchChart.data.labels=labels;
    benchChart.data.datasets[0].data=data;
    benchChart.data.datasets[0].borderColor=c;
    benchChart.data.datasets[0].pointBackgroundColor=c;
    benchChart.data.datasets[0].pointBorderColor=c;
    benchChart.data.datasets[0].backgroundColor=c.replace(')',',0.08)').replace('rgb','rgba');
    benchChart.update('none');
  } else {
    benchChart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label:'tok/s',data,borderColor:c,
        backgroundColor:c.replace(')',',0.08)').replace('rgb','rgba'),
        borderWidth:2,fill:true,tension:0.3,pointBackgroundColor:c,pointBorderColor:c,pointRadius:3,pointHoverRadius:5}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{backgroundColor:'#0c1117',borderColor:'#1a2736',borderWidth:1,
          titleFont:{family:'JetBrains Mono',size:10},bodyFont:{family:'JetBrains Mono',size:11},
          titleColor:'#5a6a7a',bodyColor:c}},
        scales:{x:{ticks:{color:'#3a4a5a',font:{family:'JetBrains Mono',size:9}},grid:{color:'rgba(26,39,54,0.4)'}},
          y:{ticks:{color:'#3a4a5a',font:{family:'JetBrains Mono',size:9},callback:v=>v+' t/s'},grid:{color:'rgba(26,39,54,0.4)'}}}}
    });
  }
}

// â”€â”€ Benchmark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runBenchmark() {
  const model=document.getElementById('benchModel').value;
  if(!model){showToast('No model selected',true);return;}
  const btn=document.getElementById('benchBtn');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Running...';
  try {
    const r=await fetch(`${API}/api/benchmark`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model})});
    const d=await r.json();
    if(d.error){showToast(d.error,true);}
    else {
      document.getElementById('brTokSec').textContent=(d.tokens_per_sec?.toFixed(1)||'â€”')+' t/s';
      document.getElementById('brTokens').textContent=d.eval_count||'â€”';
      document.getElementById('brPromptRate').textContent=(d.prompt_eval_rate?.toFixed(1)||'â€”')+' t/s';
      document.getElementById('brTotal').textContent=fmtDur(d.total_duration_ms||0);
      showToast(`Benchmark: ${d.tokens_per_sec?.toFixed(1)} tok/s`);
      await fetchHistory();
    }
  } catch(e){showToast('Failed: '+e.message,true);}
  finally { btn.disabled=false; btn.innerHTML='â–¶ Run'; }
}

// â”€â”€ Trim & Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function trimByCount() {
  const keep=parseInt(document.getElementById('trimCount').value)||500;
  if(!confirm(`Trim history to the last ${keep} entries per category?`)) return;
  try {
    await fetch(`${API}/api/trim`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'count',keep})});
    showToast(`Trimmed to last ${keep} entries`);
    await fetchHistory();
  } catch(e){showToast('Trim failed',true);}
}
async function trimByTime() {
  const months=parseInt(document.getElementById('trimMonths').value)||6;
  if(!confirm(`Delete history older than ${months} month(s)?`)) return;
  try {
    await fetch(`${API}/api/trim`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'time',months})});
    showToast(`Removed data older than ${months} month(s)`);
    await fetchHistory();
  } catch(e){showToast('Trim failed',true);}
}
async function clearHistory() {
  if(!confirm('Clear ALL history? This cannot be undone.')) return;
  try {
    await fetch(`${API}/api/clear`,{method:'POST'});
    showToast('History cleared');
    await fetchHistory();
  } catch(e){showToast('Clear failed',true);}
}
async function exportHistory() {
  try {
    const r=await fetch(`${API}/api/history/export`);
    const b=await r.blob();
    const u=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=u; a.download=`ollama-history-${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(u);
    showToast('Exported');
  } catch(e){showToast('Export failed',true);}
}

// â”€â”€ Snapshot Card Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateSnapshot() {
  const reqs = allHistory.requests || [];
  const events = allHistory.events || [];
  const benches = allHistory.benchmarks || [];

  // Gather stats
  const totalReqs = reqs.length;
  const totalTokens = reqs.reduce((s,r) => s + (r.total_tokens||0), 0);
  const tpsVals = reqs.filter(r => r.tokens_per_sec > 0).map(r => r.tokens_per_sec);
  const avgTps = tpsVals.length ? (tpsVals.reduce((a,b)=>a+b,0)/tpsVals.length).toFixed(1) : 'â€”';
  const peakTps = tpsVals.length ? Math.max(...tpsVals).toFixed(1) : 'â€”';
  const models = [...new Set(reqs.map(r=>r.model).filter(Boolean))];
  const topModel = models.length ? (() => {
    const counts = {};
    reqs.forEach(r => { if(r.model) counts[r.model] = (counts[r.model]||0)+1; });
    return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
  })() : 'â€”';
  const clients = [...new Set(reqs.map(r=>r.client_ip).filter(Boolean))];
  const totalEvents = events.length;
  const totalBenches = benches.length;

  // Canvas setup
  const W = 680, H = 420;
  const c = document.createElement('canvas');
  c.width = W; c.height = H;
  const ctx = c.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  c.width = W * dpr; c.height = H * dpr;
  c.style.width = W + 'px'; c.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  // Background
  const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
  bgGrad.addColorStop(0, '#060a0e');
  bgGrad.addColorStop(1, '#0c1520');
  ctx.fillStyle = bgGrad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();

  // Border
  ctx.strokeStyle = '#1a2736';
  ctx.lineWidth = 1;
  roundRect(ctx, 0.5, 0.5, W-1, H-1, 12);
  ctx.stroke();

  // Accent bar
  const barGrad = ctx.createLinearGradient(0, 0, W, 0);
  barGrad.addColorStop(0, '#00e87b');
  barGrad.addColorStop(1, '#00b4d8');
  ctx.fillStyle = barGrad;
  ctx.fillRect(24, 20, 4, 32);

  // Title
  ctx.fillStyle = '#c8d4de';
  ctx.font = '600 20px "Share Tech Mono", monospace';
  ctx.fillText('OLLAMA // CONTROL CENTER', 40, 43);

  // Subtitle
  ctx.fillStyle = '#3a4a5a';
  ctx.font = '12px "JetBrains Mono", monospace';
  const now = new Date();
  ctx.fillText(`Stats snapshot â€” ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 40, 62);

  // Stats grid (2 cols Ã— 4 rows)
  const stats = [
    { label: 'TOTAL REQUESTS', value: totalReqs.toLocaleString(), icon: 'ğŸ“Š' },
    { label: 'TOTAL TOKENS', value: totalTokens.toLocaleString(), icon: 'ğŸ”¤' },
    { label: 'AVG TOK/S', value: avgTps, icon: 'âš¡' },
    { label: 'PEAK TOK/S', value: peakTps, icon: 'ğŸš€' },
    { label: 'TOP MODEL', value: shortModel(topModel), icon: 'ğŸ§ ' },
    { label: 'MODELS USED', value: models.length.toString(), icon: 'ğŸ“¦' },
    { label: 'ACTIVE CLIENTS', value: clients.length.toString(), icon: 'ğŸ–¥ï¸' },
    { label: 'MODEL EVENTS', value: totalEvents.toString(), icon: 'ğŸ“¡' },
  ];

  const colW = (W - 48 - 16) / 2;
  const rowH = 62;
  const startY = 84;

  stats.forEach((s, i) => {
    const col = i % 2;
    const row = Math.floor(i / 2);
    const x = 24 + col * (colW + 16);
    const y = startY + row * rowH;

    // Card bg
    ctx.fillStyle = 'rgba(12,17,23,0.7)';
    roundRect(ctx, x, y, colW, 52, 6);
    ctx.fill();
    ctx.strokeStyle = '#1a2736';
    ctx.lineWidth = 0.5;
    roundRect(ctx, x, y, colW, 52, 6);
    ctx.stroke();

    // Icon
    ctx.font = '16px serif';
    ctx.fillText(s.icon, x + 10, y + 32);

    // Value
    ctx.fillStyle = '#00e87b';
    ctx.font = '600 18px "JetBrains Mono", monospace';
    ctx.fillText(s.value, x + 34, y + 28);

    // Label
    ctx.fillStyle = '#3a4a5a';
    ctx.font = '10px "JetBrains Mono", monospace';
    ctx.fillText(s.label, x + 34, y + 44);
  });

  // Footer
  const footY = H - 28;
  ctx.fillStyle = '#1a2736';
  ctx.fillRect(24, footY - 8, W - 48, 1);
  ctx.fillStyle = '#2a3a4a';
  ctx.font = '11px "JetBrains Mono", monospace';
  ctx.fillText(`v1.0 â€¢ ${totalBenches} benchmarks â€¢ Powered by Intel iGPU + IPEX-LLM`, 24, footY + 8);

  // Watermark
  ctx.fillStyle = '#1a2736';
  ctx.font = '10px "JetBrains Mono", monospace';
  ctx.textAlign = 'right';
  ctx.fillText('ollama-dashboard', W - 24, footY + 8);
  ctx.textAlign = 'left';

  // Download
  const link = document.createElement('a');
  link.download = `ollama-snapshot-${now.toISOString().slice(0,10)}.png`;
  link.href = c.toDataURL('image/png');
  link.click();
  showToast('Snapshot saved');
}

function shortModel(name) {
  if (!name || name === 'â€”') return 'â€”';
  // Truncate long model names
  return name.length > 22 ? name.slice(0, 20) + 'â€¦' : name;
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let settingsData = {};

async function loadSettingsUI() {
  try {
    const r = await fetch(`${API}/api/settings`);
    settingsData = await r.json();

    document.getElementById('setPollInterval').value = settingsData.poll_interval || 5;
    document.getElementById('setRetention').value = settingsData.retention_months || 6;
    document.getElementById('setSyncTheme').checked = settingsData.sync_theme || false;

    renderClientMapEditor(settingsData.client_map || {});

    // Show/hide logout button based on auth
    if (settingsData.auth_enabled) {
      document.getElementById('logoutBtn').style.display = '';
      document.getElementById('authDocInfo').innerHTML =
        'Password protection is <strong>enabled</strong>. All dashboard and API requests require a valid session cookie.';
      document.getElementById('authDocEndpoints').style.display = '';
    } else {
      document.getElementById('logoutBtn').style.display = 'none';
    }

    // If sync theme is on, apply server-saved theme
    if (settingsData.sync_theme && settingsData.theme && settingsData.mode) {
      document.documentElement.setAttribute('data-theme', settingsData.theme);
      document.documentElement.setAttribute('data-mode', settingsData.mode);
      document.getElementById('themeSelect').value = settingsData.theme;
      document.getElementById('modeLabel').textContent = settingsData.mode.toUpperCase();
    }
  } catch(e) { console.error('Settings load error', e); }
}

function renderClientMapEditor(map) {
  const list = document.getElementById('clientMapList');
  const entries = Object.entries(map);
  if (entries.length === 0) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px 0;">No client mappings configured. Click "+ Add Client" to start.</div>';
    return;
  }
  list.innerHTML = entries.map(([ip, info], i) =>
    `<div class="client-map-row" data-idx="${i}">
      <input class="input icon cm-icon" value="${info.icon||'ğŸ¤–'}" placeholder="ğŸ¤–" maxlength="4">
      <input class="input ip cm-ip" value="${ip}" placeholder="IP address">
      <input class="input name cm-name" value="${info.name||''}" placeholder="Friendly name">
      <button class="btn-sm err" onclick="this.parentElement.remove()">âœ•</button>
    </div>`
  ).join('');
}

function addClientRow() {
  const list = document.getElementById('clientMapList');
  // Remove "no mappings" message if present
  if (list.querySelector('div[style]') && !list.querySelector('.client-map-row')) {
    list.innerHTML = '';
  }
  const row = document.createElement('div');
  row.className = 'client-map-row';
  row.innerHTML = `
    <input class="input icon cm-icon" value="ğŸ¤–" placeholder="ğŸ¤–" maxlength="4">
    <input class="input ip cm-ip" value="" placeholder="IP address">
    <input class="input name cm-name" value="" placeholder="Friendly name">
    <button class="btn-sm err" onclick="this.parentElement.remove()">âœ•</button>
  `;
  list.appendChild(row);
}

function collectClientMap() {
  const map = {};
  document.querySelectorAll('.client-map-row').forEach(row => {
    const ip = row.querySelector('.cm-ip')?.value.trim();
    const name = row.querySelector('.cm-name')?.value.trim();
    const icon = row.querySelector('.cm-icon')?.value.trim() || 'ğŸ¤–';
    if (ip && name) map[ip] = { name, icon };
  });
  return map;
}

async function saveSettings() {
  const payload = {
    poll_interval: parseInt(document.getElementById('setPollInterval').value) || 5,
    retention_months: parseInt(document.getElementById('setRetention').value) || 6,
    client_map: collectClientMap(),
    sync_theme: document.getElementById('setSyncTheme').checked,
  };

  // If sync theme is on, save current theme/mode
  if (payload.sync_theme) {
    payload.theme = document.documentElement.getAttribute('data-theme');
    payload.mode = document.documentElement.getAttribute('data-mode');
  }

  try {
    const r = await fetch(`${API}/api/settings`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.ok) {
      showToast('Settings saved');
      // Reload client map
      await loadClientMap();
      renderHistory();
    } else {
      showToast('Save failed', true);
    }
  } catch(e) { showToast('Save failed: '+e.message, true); }
}

// Load settings on startup
loadSettingsUI();

// â”€â”€ Update Checker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkUpdates() {
  const btn=document.getElementById('updateBtn');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Checking...';
  try {
    const r=await fetch(`${API}/api/updates`);
    const d=await r.json();

    const pkgs=d.dashboard_packages||[];
    if(pkgs.length){
      document.getElementById('pkgList').innerHTML=pkgs.map(p=>`<div class="pkg-row">
        <span class="pkg-name">${p.package}</span>
        <span class="pkg-ver">${p.current}</span>
        <span>â†’</span>
        <span class="${p.update_available?'pkg-new':'pkg-ok'}">${p.latest} ${p.update_available?'â¬† UPDATE':'âœ“'}</span>
      </div>`).join('');
    }

    const img=d.base_image||{};
    if(img.error){
      document.getElementById('imageInfo').innerHTML=`<div class="empty">${img.error}</div>`;
    } else {
      document.getElementById('imageInfo').innerHTML=`<div class="pkg-row">
        <span class="pkg-name">${img.container||'â€”'}</span>
        <span class="pkg-ver">${img.current_image_id||'â€”'}</span>
      </div><p style="font-size:14px;color:var(--text-dim);margin-top:8px;">${img.note||''}</p>`;
    }

    showToast('Update check complete');
  } catch(e){showToast('Check failed: '+e.message,true);}
  finally { btn.disabled=false; btn.innerHTML='âŸ³ Check for Updates'; }
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function poll() { await fetchStatus(); await fetchHistory(); }
async function startPolling() {
  await poll();
  const interval = (settingsData.poll_interval || 5) * 1000;
  setInterval(poll, Math.max(interval, 2000));
}
startPolling();

// â”€â”€ Collapsible Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCollapsible() {
  document.querySelectorAll('.panel-header').forEach(header => {
    // Only panels on the dashboard page, skip charts and settings
    const panel = header.closest('.panel');
    if (!panel) return;
    const body = panel.querySelector('.panel-body');
    const filterBar = panel.querySelector('.filter-bar');
    if (!body) return;

    header.classList.add('collapsible');
    header.addEventListener('click', (e) => {
      // Don't collapse when clicking sort headers or buttons inside
      if (e.target.closest('th, button, select, .chart-toggle')) return;
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
      if (filterBar) filterBar.classList.toggle('collapsed');
    });
  });
}
initCollapsible();

// â”€â”€ Service Worker Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('[SW] Registered, scope:', reg.scope);
  }).catch(err => {
    console.log('[SW] Registration failed:', err);
  });
}
</script>
</body>
</html>
